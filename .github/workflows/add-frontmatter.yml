name: Auto-Add Front Matter

on:
  push:
    paths:
      - 'documents/**/*.md'
      - 'documents/**/*.html'
  pull_request:
    paths:
      - 'documents/**/*.md'
      - 'documents/**/*.html'

jobs:
  add-frontmatter:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Check and add front matter
        run: |
          #!/bin/bash

          echo "Checking markdown and HTML files for front matter..."

          # Track modified files
          modified_files=()

          # Process all .md and .html files in documents/
          while IFS= read -r -d '' file; do
            file_modified=false

            # Check if file starts with front matter delimiter
            if ! head -1 "$file" | grep -q "^---$"; then
              echo "üìù Adding front matter to: $file"

              # Get file extension
              extension="${file##*.}"

              # Extract title from first # heading (for MD) or <title> tag (for HTML)
              if [ "$extension" = "md" ]; then
                title=$(grep -m 1 "^# " "$file" | sed 's/^# //' | sed 's/[[:space:]]*$//')
              elif [ "$extension" = "html" ]; then
                title=$(grep -m 1 "<title>" "$file" | sed 's/.*<title>\(.*\)<\/title>.*/\1/' | sed 's/[[:space:]]*$//')
              fi

              # If no title found, use filename
              if [ -z "$title" ]; then
                # Get filename without extension and convert - and _ to spaces
                title=$(basename "$file" .$extension | sed 's/[-_]/ /g' | sed 's/\b\(.\)/\u\1/g')
              fi

              # Get the first commit date for this file (creation date from Git)
              # Use --diff-filter=A to get only the "Added" commit
              commit_date=$(git log --diff-filter=A --follow --format=%aI --reverse -- "$file" | head -1)

              # If no commit date found (new file not yet committed), use current date
              if [ -z "$commit_date" ]; then
                commit_date=$(date -u +"%Y-%m-%dT%H:%M:%S%z")
                echo "‚ö†Ô∏è  No Git history found for $file, using current date: $commit_date"
              else
                echo "üìÖ Found creation date for $file: $commit_date"
              fi

              # Extract just the date part (YYYY-MM-DD)
              date_only=$(echo "$commit_date" | cut -d'T' -f1)

              # Create temp file with front matter + original content
              {
                echo "---"
                echo "title: \"$title\""
                echo "date: $date_only"
                echo "---"
                echo ""
                cat "$file"
              } > "$file.tmp"

              # Replace original file
              mv "$file.tmp" "$file"
              file_modified=true
            else
              echo "‚úÖ Front matter exists: $file"

              # Check if existing front matter has a date field
              if ! head -10 "$file" | grep -q "^date:"; then
                echo "üìÖ Adding date to existing front matter: $file"

                # Get the first commit date for this file
                commit_date=$(git log --diff-filter=A --follow --format=%aI --reverse -- "$file" | head -1)

                if [ -z "$commit_date" ]; then
                  commit_date=$(date -u +"%Y-%m-%dT%H:%M:%S%z")
                fi

                date_only=$(echo "$commit_date" | cut -d'T' -f1)

                # Insert date after the first line of front matter (after ---)
                sed -i.bak "1 a\\
date: $date_only" "$file"
                rm -f "$file.bak"
                file_modified=true
              fi
            fi

            # Fix image paths for Jekyll (convert relative to absolute) - only for MD files
            if [ "$extension" = "md" ] && grep -q '!\[.*\](\.*/images/' "$file"; then
              echo "üñºÔ∏è  Fixing image paths in: $file"

              # Convert ./images/ to /sharehub/images/
              sed -i.bak 's|!\[\([^]]*\)\](\.*/images/\([^)]*\))|![\1](/sharehub/images/\2)|g' "$file"
              rm -f "$file.bak"
              file_modified=true
            fi

            # Track this file if modified
            if [ "$file_modified" = true ]; then
              modified_files+=("$file")
            fi
          done < <(find documents \( -name "*.md" -o -name "*.html" \) -type f -print0)

          # Set environment variable
          echo "modified=${#modified_files[@]}" >> $GITHUB_ENV

          # Output summary
          echo "Modified ${#modified_files[@]} file(s)"

      - name: Commit and push if changes were made
        if: env.modified != '0'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add documents/
          git commit -m "ü§ñ Auto-add front matter with Git creation dates and fix image paths"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          if [ "${{ env.modified }}" -eq "0" ]; then
            echo "‚úÖ All markdown files already have front matter!"
          else
            echo "‚úÖ Added front matter to ${{ env.modified }} file(s)"
          fi

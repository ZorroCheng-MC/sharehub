name: Auto-Add Front Matter

on:
  push:
    paths:
      - 'documents/**/*.md'
  pull_request:
    paths:
      - 'documents/**/*.md'

jobs:
  add-frontmatter:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Check and add front matter
        run: |
          #!/bin/bash

          echo "Checking markdown files for front matter..."

          # Track modified files
          modified_files=()

          # Find all .md files in documents/
          while IFS= read -r -d '' file; do
            file_modified=false

            # Check if file starts with front matter delimiter
            if ! head -1 "$file" | grep -q "^---$"; then
              echo "üìù Adding front matter to: $file"

              # Extract title from first # heading
              title=$(grep -m 1 "^# " "$file" | sed 's/^# //' | sed 's/[[:space:]]*$//')

              # If no title found, use filename
              if [ -z "$title" ]; then
                # Get filename without extension and convert - and _ to spaces
                title=$(basename "$file" .md | sed 's/[-_]/ /g' | sed 's/\b\(.\)/\u\1/g')
              fi

              # Create temp file with front matter + original content
              {
                echo "---"
                echo "title: \"$title\""
                echo "---"
                echo ""
                cat "$file"
              } > "$file.tmp"

              # Replace original file
              mv "$file.tmp" "$file"
              file_modified=true
            else
              echo "‚úÖ Front matter exists: $file"
            fi

            # Make images responsive by converting markdown images to HTML with styling
            if grep -q '!\[.*\](.*\.jpg\|.*\.png\|.*\.gif\|.*\.jpeg)' "$file"; then
              echo "üñºÔ∏è  Making images responsive in: $file"

              # Convert ![alt](src) to <img src="src" alt="alt" style="max-width: 100%; height: auto; display: block;">
              sed -i.bak -E 's|!\[([^]]*)\]\(([^)]+\.(jpg\|png\|gif\|jpeg))\)|<img src="\2" alt="\1" style="max-width: 100%; height: auto; display: block;">|g' "$file"
              rm -f "$file.bak"
              file_modified=true
            fi

            # Track this file if modified
            if [ "$file_modified" = true ]; then
              modified_files+=("$file")
            fi
          done < <(find documents -name "*.md" -type f -print0)

          # Set environment variable
          echo "modified=${#modified_files[@]}" >> $GITHUB_ENV

          # Output summary
          echo "Modified ${#modified_files[@]} file(s)"

      - name: Commit and push if changes were made
        if: env.modified != '0'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add documents/
          git commit -m "ü§ñ Auto-add front matter and responsive image styling"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          if [ "${{ env.modified }}" -eq "0" ]; then
            echo "‚úÖ All markdown files already have front matter!"
          else
            echo "‚úÖ Added front matter to ${{ env.modified }} file(s)"
          fi
